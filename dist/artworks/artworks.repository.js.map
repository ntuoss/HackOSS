{"version":3,"file":"artworks.repository.js","sourceRoot":"","sources":["../../src/artworks/artworks.repository.ts"],"names":[],"mappings":";;;AAIA,kCAA2D;AAC3D,2CAAyC;AAMzC,IAAM,2BAA2B,GAA2C;IACxE,OAAO,EAAE,OAAO;CACnB,CAAC;AASF;IAMI,4BACI,eAAmC,EACnC,gBAAkC;QAFtC,iBAgBC;QAZG,IAAI,CAAC,kBAAkB,GAAG,eAAe,CAAC;QAC1C,IAAI,CAAC,gBAAgB,GAAG,gBAAgB,CAAC;QACzC,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,kBAAkB,CAAC,SAAS,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC;QAEzE,wBAAU,CAAC,aAAa,GAAG,UAAC,SAAiB,IAAK,OAAA,IAAI,OAAO,CAAC,UAAO,OAAO;;;;4BAC5D,qBAAM,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,GAAG,EAAE,EAAA;;wBAA9C,GAAG,GAAG,SAAwC;wBACpD,IAAI,GAAG,CAAC,MAAM,EAAE;4BACZ,OAAO,EAAE,CAAC;yBACb;6BAAM;4BACH,OAAO,CAAC,qBAAmB,SAAS,gCAA6B,CAAC,CAAC;yBACtE;;;;aACJ,CAAC,EAPgD,CAOhD,CAAC;IACP,CAAC;IAEK,0CAAa,GAAnB,UAAoB,OAAmB;;;;gBAC7B,UAAU,GAAkC;oBAC9C,KAAK,EAAE,OAAO,CAAC,KAAK;oBACpB,QAAQ,EAAE,OAAO,CAAC,QAAQ;oBAC1B,YAAY,EAAE,OAAO,CAAC,YAAY;oBAClC,MAAM,EAAE,IAAI,CAAC,gBAAgB,CAAC,MAAM,CAAC,GAAG,CAAC,OAAO,CAAC,QAAQ,CAAC;iBAC7D,CAAC;gBACF,sBAAO,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,UAAU,CAAC,EAAC;;;KACxC;IAEK,wCAAW,GAAjB,UACI,OAA2B,EAC3B,KAAkB,EAClB,OAAmC,EACnC,SAAsD;QAHtD,wBAAA,EAAA,YAA2B;QAC3B,sBAAA,EAAA,UAAkB;QAClB,wBAAA,EAAA,iBAAmC;QACnC,0BAAA,EAAA,iBAAsD;;;;;;;wBAEhD,WAAW,GAAG,2BAA2B,CAAC,OAAO,CAAC,CAAC;wBACzC,qBAAM,kBAAU,CAAC,IAAI,CAAC,QAAQ,EAAE,KAAK,EAAE,WAAW,EAAE,SAAS,EAAE,OAAO,CAAC,CAAC,GAAG,EAAE,EAAA;;wBAAvF,OAAO,GAAG,SAA6E;wBAC7F,aAAa;wBACb,sBAAO,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,UAAM,GAAG;;4CAAI,qBAAM,IAAI,CAAC,SAAS,sBAAM,GAAG,CAAC,IAAI,EAAE,IAAE,EAAE,EAAE,GAAG,CAAC,EAAE,IAAG,EAAA;4CAAnD,sBAAA,SAAmD,EAAA;;qCAAA,CAAC,CAAC,EAAC;;;;KAC1G;IAEK,uCAAU,GAAhB,UAAiB,EAAU;;;;;;wBACjB,GAAG,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC;wBACtB,qBAAM,GAAG,CAAC,GAAG,EAAE,EAAA;;wBAArB,GAAG,GAAG,SAAe;wBAC3B,aAAa;wBACb,sBAAO,IAAI,CAAC,SAAS,sBAAM,GAAG,CAAC,IAAI,EAAE,IAAE,EAAE,IAAA,IAAG,EAAC;;;;KAChD;IAEa,sCAAS,GAAvB,UAAwB,IAAqB;;;;;4BAC1B,qBAAM,IAAI,CAAC,gBAAgB,CAAC,SAAS,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,EAAA;;wBAA9D,MAAM,GAAG,SAAqD;wBACpE,2CAAY,IAAI,IAAE,MAAM,QAAA,KAAG;;;;KAC9B;IAEL,yBAAC;AAAD,CAAC,AA1DD,IA0DC;AA1DY,gDAAkB","sourcesContent":["import { FirebaseRepository } from '../firebase/firebase.repository';\nimport { Artwork } from './artwork';\nimport { FirebaseArtwork } from './artwork.firebase';\nimport { PeopleRepository } from '../people/people.repository';\nimport { withId, QueryFilter, buildQuery } from '../utils';\nimport { validators } from 'validate.js';\nimport * as firebase from 'firebase/app';\nimport _ from 'lodash';\n\nexport type ArtworksOrderKey = 'title';\n\nconst ARTWORKS_ORDER_KEY_PATH_MAP: { [key in ArtworksOrderKey]: string; } = {\n    'title': 'title'\n};\n\nexport interface NewArtwork {\n    title: string;\n    imageUrl: string;\n    artistId: string;\n    eventbriteId: string;\n}\n\nexport class ArtworksRepository {\n\n    private firebaseRepository: FirebaseRepository;\n    private peopleRepository: PeopleRepository;\n    artworks: firebase.firestore.CollectionReference;\n\n    constructor(\n        firebaseService: FirebaseRepository,\n        peopleRepository: PeopleRepository\n    ) {\n        this.firebaseRepository = firebaseService;\n        this.peopleRepository = peopleRepository;\n        this.artworks = this.firebaseRepository.firestore.collection('artworks');\n\n        validators.artworkExists = (artworkId: string) => new Promise(async (resolve) => {\n            const doc = await this.artworks.doc(artworkId).get();\n            if (doc.exists) {\n                resolve();\n            } else {\n                resolve(`Artwork with ID ${artworkId} does not exist in Firebase`);\n            }\n        });\n    }\n\n    async createArtwork(artwork: NewArtwork) {\n        const newArtwork: _.Omit<FirebaseArtwork, 'id'> = {\n            title: artwork.title,\n            imageUrl: artwork.imageUrl,\n            eventbriteId: artwork.eventbriteId,\n            artist: this.peopleRepository.people.doc(artwork.artistId)\n        };\n        return this.artworks.add(newArtwork);\n    }\n\n    async getArtworks(\n        filters: QueryFilter[] = [],\n        limit: number = 10,\n        orderBy: ArtworksOrderKey = 'title',\n        direction: firebase.firestore.OrderByDirection = 'asc'\n    ): Promise<Artwork[]> {\n        const orderByPath = ARTWORKS_ORDER_KEY_PATH_MAP[orderBy];\n        const results = await buildQuery(this.artworks, limit, orderByPath, direction, filters).get();\n        // @ts-ignore\n        return Promise.all(results.docs.map(async doc => await this.toArtwork({ ...doc.data(), id: doc.id })));\n    }\n\n    async getArtwork(id: string): Promise<Artwork> {\n        const ref = this.artworks.doc(id);\n        const doc = await ref.get();\n        // @ts-ignore\n        return this.toArtwork({ ...doc.data(), id });\n    }\n\n    private async toArtwork(data: FirebaseArtwork): Promise<Artwork> {\n        const artist = await this.peopleRepository.getPerson(data.artist.id);\n        return { ...data, artist };\n    }\n\n}\n"]}